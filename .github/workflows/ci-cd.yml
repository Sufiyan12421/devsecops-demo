name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'kubernetes/deployment.yaml'
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io

jobs:
  # ----------------------
  # 1️⃣ Unit Tests
  # ----------------------
  test:
    name: Unit Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install
      - run: npm test

  # ----------------------
  # 2️⃣ Build & Push Docker Image
  # ----------------------
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}:latest

  # ----------------------
  # 3️⃣ Security Scan with Trivy
  # ----------------------
  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy
        uses: aquasecurity/trivy-action@master

      - name: Set variables
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Scan Docker image for vulnerabilities
        run: |
          echo "Scanning image: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }}"
          trivy image ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} \
            --exit-code 1 \
            --severity CRITICAL,HIGH

      - name: Scan source code for secrets/IaC
        run: trivy fs . --exit-code 1 --severity CRITICAL,HIGH

  # ----------------------
  # 4️⃣ Deploy to Kubernetes
  # ----------------------
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: trivy
    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Set up Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

      - name: Update Kubernetes Deployment
        run: |
          kubectl set image deployment/devsecops-demo \
            devsecops-demo=${{ env.REGISTRY }}/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} \
            -n default
          kubectl rollout status deployment/devsecops-demo -n default
